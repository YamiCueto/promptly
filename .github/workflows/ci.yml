name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [18.x, 20.x]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
    
    - name: Install dependencies
      run: npm install

    - name: Lint project
      run: |
        echo "ğŸ” Checking project structure..."
        # Verificar que existen los archivos principales
        test -f index.html || (echo "âŒ index.html not found" && exit 1)
        test -f css/styles.css || (echo "âŒ styles.css not found" && exit 1)
        test -f js/app.js || (echo "âŒ app.js not found" && exit 1)
        test -f js/chat.js || (echo "âŒ chat.js not found" && exit 1)
        test -f js/config.js || (echo "âŒ config.js not found" && exit 1)
        test -f js/providers.js || (echo "âŒ providers.js not found" && exit 1)
        echo "âœ… All required files exist"
    
    - name: Validate HTML
      run: |
        echo "ğŸ” Validating HTML structure..."
        # Verificar que el HTML tiene la estructura bÃ¡sica
        grep -q "<!DOCTYPE html>" index.html || (echo "âŒ Missing DOCTYPE" && exit 1)
        grep -q "<title>" index.html || (echo "âŒ Missing title" && exit 1)
        grep -q "chatMessages" index.html || (echo "âŒ Missing chat container" && exit 1)
        grep -q "messageInput" index.html || (echo "âŒ Missing message input" && exit 1)
        echo "âœ… HTML structure is valid"
    
    - name: Validate JavaScript
      run: |
        echo "ğŸ” Checking JavaScript syntax..."
        # Verificar sintaxis bÃ¡sica de JavaScript
        node -c js/config.js || (echo "âŒ config.js has syntax errors" && exit 1)
        node -c js/providers.js || (echo "âŒ providers.js has syntax errors" && exit 1)
        node -c js/chat.js || (echo "âŒ chat.js has syntax errors" && exit 1)
        node -c js/app.js || (echo "âŒ app.js has syntax errors" && exit 1)
        echo "âœ… JavaScript syntax is valid"
    
    - name: Check CSS
      run: |
        echo "ğŸ” Validating CSS..."
        # Verificar que el CSS tiene las clases principales
        grep -q "\.app-container" css/styles.css || (echo "âŒ Missing app-container class" && exit 1)
        grep -q "\.chat-messages" css/styles.css || (echo "âŒ Missing chat-messages class" && exit 1)
        grep -q "\.message-input" css/styles.css || (echo "âŒ Missing message-input class" && exit 1)
        echo "âœ… CSS structure is valid"
    
    - name: Test local server
      run: |
        echo "ğŸš€ Testing server setup..."
        # Simplemente verificar que http-server puede iniciarse
        npx http-server --help > /dev/null && echo "âœ… http-server available" || echo "âš ï¸ http-server not available"
        echo "âœ… Server setup test completed"
    
    - name: Check file sizes
      run: |
        echo "ğŸ“Š Checking file sizes..."
        HTML_SIZE=$(stat -c%s index.html)
        CSS_SIZE=$(stat -c%s css/styles.css)
        JS_TOTAL=$(find js -name "*.js" -exec stat -c%s {} \; | awk '{sum+=$1} END {print sum}')
        
        echo "ğŸ“„ HTML: $HTML_SIZE bytes"
        echo "ğŸ¨ CSS: $CSS_SIZE bytes"  
        echo "âš¡ JavaScript: $JS_TOTAL bytes"
        
        TOTAL_SIZE=$((HTML_SIZE + CSS_SIZE + JS_TOTAL))
        echo "ğŸ“¦ Total size: $TOTAL_SIZE bytes"
        
        # Verificar que el tamaÃ±o total es razonable (< 100KB)
        if [ $TOTAL_SIZE -gt 102400 ]; then
          echo "âš ï¸ Warning: Total size is larger than 100KB"
        else
          echo "âœ… Total size is optimal"
        fi